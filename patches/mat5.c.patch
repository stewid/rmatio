*** mat5.c.orig	2017-07-29 17:12:59.941302424 +0200
--- mat5.c	2017-07-29 17:11:51.510159039 +0200
***************
*** 48,53 ****
--- 48,93 ----
  
  static mat_complex_split_t null_complex_data = {NULL,NULL};
  
+ /* Stefan Widgren 2014-01-05: Moved the following forward declarations
+  * from mat5.h to silent compiler warnings on windows*/
+ static size_t GetTypeBufSize(matvar_t *matvar);
+ static size_t GetStructFieldBufSize(matvar_t *matvar);
+ static size_t GetCellArrayFieldBufSize(matvar_t *matvar);
+ static size_t GetMatrixMaxBufSize(matvar_t *matvar);
+ static size_t GetEmptyMatrixMaxBufSize(const char *name,int rank);
+ static size_t WriteCharData(mat_t *mat, void *data, int N,enum matio_types data_type);
+ static size_t WriteEmptyCharData(mat_t *mat, int N, enum matio_types data_type);
+ static size_t WriteEmptyData(mat_t *mat,int N,enum matio_types data_type);
+ static size_t ReadNextCell( mat_t *mat, matvar_t *matvar );
+ static size_t ReadNextStructField( mat_t *mat, matvar_t *matvar );
+ static size_t ReadNextFunctionHandle(mat_t *mat, matvar_t *matvar);
+ static int WriteType(mat_t *mat,matvar_t *matvar);
+ static int WriteCellArrayFieldInfo(mat_t *mat,matvar_t *matvar);
+ static int WriteCellArrayField(mat_t *mat,matvar_t *matvar );
+ static int WriteStructField(mat_t *mat,matvar_t *matvar);
+ static size_t Mat_WriteEmptyVariable5(mat_t *mat,const char *name,int rank,
+                   size_t *dims);
+ #if defined(HAVE_ZLIB)
+ static size_t WriteCompressedCharData(mat_t *mat,z_streamp z,void *data,int N,
+                   enum matio_types data_type);
+ /* Stefan Widgren 2014-01-05: Commented out to silent compiler warning
+  * unused function */
+ /* static size_t WriteCompressedEmptyData(mat_t *mat,z_streamp z,int N, */
+ /*                   enum matio_types data_type); */
+ static size_t WriteCompressedData(mat_t *mat,z_streamp z,void *data,int N,
+                   enum matio_types data_type);
+ static size_t WriteCompressedTypeArrayFlags(mat_t *mat,matvar_t *matvar,
+                   z_streamp z);
+ static size_t WriteCompressedType(mat_t *mat,matvar_t *matvar,z_streamp z);
+ static size_t WriteCompressedCellArrayField(mat_t *mat,matvar_t *matvar,
+                   z_streamp z);
+ static size_t WriteCompressedStructField(mat_t *mat,matvar_t *matvar,
+                   z_streamp z);
+ static size_t Mat_WriteCompressedEmptyVariable5(mat_t *mat,const char *name,
+                   int rank,size_t *dims,z_streamp z);
+ #endif
+ 
+ 
  /*
   * -------------------------------------------------------------
   *   Private Functions
***************
*** 856,911 ****
      return nBytes;
  }
  
- #if defined(HAVE_ZLIB)
- static size_t
- WriteCompressedEmptyData(mat_t *mat,z_streamp z,int N,
-     enum matio_types data_type)
- {
-     int nBytes = 0, data_size, i;
-     size_t byteswritten = 0;
- 
-     if ( mat == NULL || mat->fp == NULL )
-         return 0;
- 
-     data_size = Mat_SizeOf(data_type);
- 
-     switch ( data_type ) {
-         case MAT_T_DOUBLE:
-         {
-             mat_uint32_t uncomp_buf[32] = {0,};
-             mat_uint32_t comp_buf[32] = {0,};
-             double data_uncomp_buf[4] = {0.0,};
- 
-             nBytes = N*data_size;
-             uncomp_buf[0] = data_type;
-             uncomp_buf[1] = 0;
-             z->next_in  = ZLIB_BYTE_PTR(uncomp_buf);
-             z->avail_in = 8;
-             do {
-                 z->next_out  = ZLIB_BYTE_PTR(comp_buf);
-                 z->avail_out = 32*sizeof(*comp_buf);
-                 deflate(z,Z_NO_FLUSH);
-                 byteswritten += fwrite(comp_buf,1,32*sizeof(*comp_buf)-z->avail_out,(FILE*)mat->fp);
-             } while ( z->avail_out == 0 );
-             for ( i = 0; i < N; i++ ) {
-                 z->next_in  = ZLIB_BYTE_PTR(data_uncomp_buf);
-                 z->avail_in = 8;
-                 do {
-                     z->next_out  = ZLIB_BYTE_PTR(comp_buf);
-                     z->avail_out = 32*sizeof(*comp_buf);
-                     deflate(z,Z_NO_FLUSH);
-                     byteswritten += fwrite(comp_buf,32*sizeof(*comp_buf)-z->avail_out,1,(FILE*)mat->fp);
-                 } while ( z->avail_out == 0 );
-             }
-             break;
-         }
-         default:
-             nBytes = WriteEmptyData(mat,N,data_type);
-     }
-     return byteswritten;
- }
- #endif
- 
  #define WRITE_DATA_SLAB2 \
      do { \
          int i, j; \
--- 896,901 ----
***************
*** 4311,4317 ****
      int rank, size_t nbytes)
  {
      int err = 0;
-     int data_size = Mat_SizeOf(data_type);
      int same_type = 0;
      if (( class_type == MAT_C_DOUBLE && data_type == MAT_T_DOUBLE ) ||
          ( class_type == MAT_C_SINGLE && data_type == MAT_T_SINGLE ) ||
--- 4301,4306 ----
***************
*** 4407,4413 ****
              }
          }
      } else {
!         int nBytes = 0, i, j, N, I = 0;
          int inc[10] = {0,}, cnt[10] = {0,}, dimp[10] = {0,};
  
          switch ( class_type ) {
--- 4396,4402 ----
              }
          }
      } else {
!         int i, j, N, I = 0;
          int inc[10] = {0,}, cnt[10] = {0,}, dimp[10] = {0,};
  
          switch ( class_type ) {
